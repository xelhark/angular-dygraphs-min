/*! angular-dygraphs - v0.1.0 - 2014-11-03
* https://github.com/xelhark/angular-dygraphs
* Copyright (c) 2014 Gabriele Platania; Licensed  */
angular.module("angular-dygraphs",["ngSanitize"]).directive("ngDygraphs",["$window","$sce",function(a,b){return{restrict:"E",scope:{data:"=",options:"=",legend:"=?"},template:'<div class="ng-dygraphs"><div class="graph"></div><div class="legend" ng-if="LegendEnabled"><div class="series-container"><div ng-repeat="series in legendSeries" class="series"><a ng-click="selectSeries(series)"><span ng-bind-html="seriesLine(series)"></span><span ng-style="seriesStyle(series)">{{series.label}}</span></a></div></div></div><div class="dypopover"></div></div>',link:function(c,d){function e(){var a=0;d.find("div.series").each(function(){var b=$(this).width();a=Math.max(a,b)}),d.find("div.series").each(function(){$(this).width(a)});var b=d.find("div.legend").outerHeight(!0);console.log("Heights",b,g.height(),g.outerHeight(!0),$(h).outerHeight(),d.height(),$(j).height(),$(j).outerHeight(!0)),o.resize(g.width(),g.height()-b),f=$(i).offset(),f.bottom=f.top+g.height()-b,f.right=f.left+g.width(),console.log("Position",f)}c.LegendEnabled=!0;var f,g=d.parent(),h=d.children()[0],i=$(h).children()[0],j=$(h).children()[1],k=d.find(".dypopover"),l=0,m=0,n=!1,o=new Dygraph(i,c.data,c.options);c.$watch("data",function(){var a=c.options;void 0===a&&(a={}),a.file=c.data,a.highlightCallback=c.highlightCallback,a.unhighlightCallback=c.unhighlightCallback,void 0===a.showPopover&&(a.showPopover=!0),void 0!==c.legend&&(a.labelsDivWidth=0),o.updateOptions(a),o.resetZoom(),e()},!0),c.$watch("legend",function(){{var a=o.getColors();o.getLabels()}if(c.legendSeries={},void 0!==c.legend&&void 0===c.legend.dateFormat&&(c.legend.dateFormat="MMMM Do YYYY, h:mm:ss a"),void 0!==c.legend&&void 0!==c.legend.series){var b=0;for(var d in c.legend.series)c.legendSeries[d]={},c.legendSeries[d].color=a[b],c.legendSeries[d].label=c.legend.series[d].label,c.legendSeries[d].format=c.legend.series[d].format,c.legendSeries[d].visible=!0,c.legendSeries[d].column=b,b++}e()}),c.highlightCallback=function(a,b,d,e){if(c.options.showPopover){console.log(a,b,d,e);var f="<table><tr><th colspan='2'>";f+="function"==typeof moment?moment(b).format(c.legend.dateFormat):b,f+="</th></tr>",angular.forEach(d,function(a){var b,d,e;void 0!==c.legendSeries[a.name]?(d=c.legendSeries[a.name].label,b="style='color:"+c.legendSeries[a.name].color+";'",e=c.legendSeries[a.name].format?a.yval.toFixed(c.legendSeries[a.name].format):a.yval):(d=a.name,b=""),f+="<tr "+b+"><td>"+d+"</td><td>"+e+"</td></tr>"}),f+="</table>",k.html(f),k.show();var g=k.find("table");l=g.outerWidth(!0),m=g.outerHeight(!0),d[0].x<.4?n=!1:d[0].x>.6&&(n=!0);var b;b=1==n?a.pageX-l-20:a.pageX+20,k.width(l),k.height(m),k.animate({left:b+"px",top:a.pageY-m/2+"px"},20),console.log("Moving",{left:b+"px",top:a.pageY-m/2+"px"})}},c.unhighlightCallback=function(a,b,d){if(!c.options.showPopover)return void k.hide();if(a.pageX>f.left&&a.pageX<f.right&&a.pageY>f.top&&a.pageY<f.bottom){var e;return e=1==n?a.pageX-l-20:a.pageX+20,void k.animate({left:e+"px"},10)}console.log(a,b,d),k.hide()},c.seriesLine=function(a){return b.trustAsHtml('<svg height="14" width="20"><line x1="0" x2="16" y1="8" y2="8" stroke="'+a.color+'" stroke-width="3" /></svg>')},c.seriesStyle=function(a){return a.visible?{color:a.color}:{}},c.selectSeries=function(a){console.log("Change series",a),a.visible=!a.visible,o.setVisibility(a.column,a.visible)},e();var p=angular.element(a);p.bind("resize",function(){e()})}}}]);